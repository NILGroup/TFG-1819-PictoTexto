% !TeX encoding = ISO-8859-1

\chapter{Pict2Text}
\label{cap:Pict2Text}

En el siguiente capitulo hablaremos de la arquitectura que hemos diseñado para la aplicación los distintos módulos de la misma y como se integran entre si. La aplicación esta formada por diferentes partes o módulos que se integran para conseguir la traducción de pictogramas a lenguaje natural, además para facilitar su uso se ha añadido un buscador de pictogramas y un traductor de pictogramas por id, tal y como podemos ver en la Figura \ref{fig:appEscritorio}, además hemos querido desarrollar la aplicación para que sea responsive y se pueda utilizar en cualquier dispositivo.
\figura{Bitmap/Arquitectura/appEscritorio}{width=430px}{fig:appEscritorio}{Pict2Text versión escritorio}
\figura{Bitmap/Arquitectura/appMo}{width=100px}{fig:appMo}{Pict2Text versión escritorio}

%------------------------------------------------------------------
\section{Arquitectura}
%-------------------------------------------------------------------
\label{cap5:sec:Arquitectura}

El trabajo de este TFG está englobado dentro del proyecto nacional IDiLyCo\footnote{http://nil.fdi.ucm.es/index.php?q=projects/idilyco}. IDiLyCo es un proyecto que busca facilitar la inclusión digital, de aquellas personas que por diversidad   funcional, tienen problemas con el lenguaje natural. Uno de los objetivos del proyecto es desarrollar pequeñas piezas de funcionalidad reutilizables que se combinan en diferentes aplicaciones, es por ello que  debíamos diseñar una arquitectura con muy bajo acoplamiento. Por esa razón hemos decidido utilizar una arquitectura orientada a servicios en la parte back-end, y a componentes en la parte front-end. En ambas casos, hemos seguido los principios\citep{martin2013agile}: 

\begin{itemize}

\item Principio de Responsabilidad única. Este principio promueve la separación de las clases para que cada clase haga una sola cosa, y no dependa de un tercero. Cada clase debe de ser responsable únicamente de su comportamiento y no tener dependencia de un tercero. Un ejemplo de violación de este principio es cuando en una misma clase, están involucradas dos capas diferentes de la arquitectura. Además este principio promueve la creación de múltiples clases muy simples, con lógica mínima, en contra de una clase con una lógica mayor, ya que esta ultima produce un fuerte acoplamiento y disminuye la sostenibilidad del código. Por ejemplo en nuestro proyecto todos los Servicios Web, son independientes unos de  otros.

\item Principio de Segregación de la Interfaz. Este principio busca abstraer lo máximo posible las interfaces de todas las clases, para así poder re-aprovecharlas en otras clases. Un ejemplo es la interfaz de peticiones de la aplicación angular donde todos los componentes de la aplicación hacen uso de la misma clase para lanzar las peticiones a los servicios web.

\item Principio de Inversión de Dependencias. Consiste en evitar dependencias externas dentro del código, y que el código central de las aplicaciones no dependa de frameworks, de bases de datos o del como se conecten los diferentes servicios entre ellos. Normalmente se habla de que las clases de alto nivel no deben de depender de las clases de bajo nivel\footnote{https://devexperto.com/principio-de-inversión-de-dependencias/}, un ejemplo de esto en nuestra aplicación es el uso de Servicios Web, que reciben tipos básicos y devuelven los resultados en formato JSON.

\end{itemize}

Estos principios tienen como finalidad crear un producto software de calidad que sea robusto, producir código ordenado y limpio dando además una gran flexibilidad buscando que sea reutilizable y fácilmente sostenible gracias al bajo acoplamiento que se consigue y por ultimo permitir la escalabilidad, gracias a una alta modular obtenida por la separación de responsabilidades.



%------------------------------------------------------------------
\section{Front-end}
%-------------------------------------------------------------------
\label{cap5:sec:ComponentesAngular}

En esta sección introduciremos los diferentes servicios y componentes Angular desarrollados para la parte Front-End de la aplicación. Hemos implementado diferentes componentes: un buscador de pictogramas, un traductor de pictograma por id, y el componente traductor de pictogramas, que sirve de contenedor para los diferentes pictogramas que vamos a traducir. Cabe destacar que cada uno de estos componentes posee un HTML, controlador y servicio de aplicación propio.  A parte de estos componentes hemos implementado una serie de útiles, como un archivo de constantes, para almacenar las diferentes direcciones de los servicios web, un servicio proxy que permite abstraer las peticiones HTTP, y por ultimo otro servicio de modales para el tratamiento de errores.


\subsection{Servicio Proxy}

El Servicio Proxy de la aplicación Angular sirve para abstraer las diferentes llamadas HTTP del resto de la aplicación, este componente es necesario ya que sirve de punto de acceso a los Servicios Web explicados en el Capitulo \ref{cap5:serviciosWeb}. Los métodos se encargan de emitir las peticiones HTTP (GET o POST), esperar la respuesta del servicio y devolverla al servicio de aplicación.
Cuando una clase llama a un método del Servicio Proxy, se convierte en un subscriptor de dicho método. Gracias a la suscripción cuando el Servicio Proxy reciba la respuesta de la llamada HTTP, se encargara de avisar a sus suscriptores de que ya ha recibido la respuesta y entregarla. Esto es gracias al patrón Observer que implementa Angular en las llamadas HTTP. En caso de que la respuesta de la llamada fuera un error, el Servicio Proxy, volverá a reintentar la llamada hasta cinco veces, si la ultima llamada falla, devuelve el error a los suscriptores. En la Figura \ref{fig:proxyClassDiagram} podemos ver un diagrama del Servicio Proxy.
\figura{Bitmap/Arquitectura/proxyService}{width=200px}{fig:proxyClassDiagram}{Diagrama de clase del Servicio Proxy}

\subsection{Servicio de modales}  
\figura{Bitmap/Arquitectura/modalErrorServiceExample}{width=400px}{fig:errorModalExample}{Ejemplo de modal para un error del tipo 404}
El servicio de modales, es un componente reutilizable que se inyecta en los componentes. Su utilidad principal es construir y mostrar una modal  genérica, dado un error especifico, con el fin de mostrar dar al usuario feedback de los errores que puedan darse. Sigue el patrón Factory, es decir su finalidad es crear objetos concretos gracias a sus datos de entrada, tal y como podemos ver en la Figura \ref{fig:errorModalExample}. Además de esto hemos utilizado la librería NGBoostrap\footnote{https://ng-bootstrap.github.io/} para la implementación de este servicio de modales, esta librería hace uso del patron Singleton para las modales, y ademas abstrae todos la funcionalidad relacionada con el uso de modales, como pueda ser la lógica de abrir o cerrar la modal. Además de la funcionalidad tiene estilos CSS propios, que ayudan a definir el tamaño de la modal, el fondo que se pone sobre el body de la pagina etc. 
Este servicio tiene dos variables de entrada el código de error y el texto asociado al error, ambos obtenidos del error devuelto por el servicio. En la Figura \ref{fig:modalErrorServiceClass}
\figura{Bitmap/Arquitectura/modalErrorServiceClass}{width=200px}{fig:modalErrorServiceClass}{Diagrama de clase del servicio de modales}

\subsection{Traductor de pictogramas} 

Este componente sirve de contenedor del array de pictogramas que después traduciremos y para lanzar la traducción.
En el HTML el componente implementa un contenedor para los pictogramas, donde se muestran la frase de pictogramas, este contenedor se ha implementado usando la biblioteca Material de Angular\footnote{https://material.angular.io/}, además existe un botón para lanzar la traducción y el parrafo donde se mostrara el resultado de la traducción. 
Además este componente tiene un controlador y un servicio de aplicación propio.
El controlador de este componente se encarga de manejar la logica drag and drop que posee el contenedor de pictogramas, y la lógica de borrado de los pictogramas.
\figura{Bitmap/Arquitectura/translatorComponent}{width=300px}{fig:translatorComponent}{Diagrama de clase del componente traductor}
Figura \ref{fig:translatorComponent}

El servicio de aplicación, genera el cuerpo de la petición POST, carga la URL del Servicio de Generación de Lenguaje del archivo de constantes, y después llama al Servicio Proxy el cual sera encargado de lanzar la petición POST y devolver la respuesta del servicio. Una vez se obtiene la respuesta del servicio se devuelve al controlador del componente.

\subsection{Buscador de pictogramas}
La utilidad principal del Buscador de pictogramas es ser el punto de entrada de los pictogramas a la aplicación. El componente esta formado por un input donde introducir el nombre del pictograma que se desea buscar y un carrusel de pictogramas que permanece oculto hasta que se busca un pictograma. Una vez introducido el pictograma que se desea buscar. El carrusel ha sido implementado gracias a la librería NGBoostrap, gracias al carrusel podemos añadir más de un pictograma al componente Traductor de Pictogramas. 
A parte de la parte visual, este componente posee un controlador, un servicio de aplicación propios y un transformer.
 El controlador es el encargado de conectar el HTML con el resto de la aplicación Angular, su utilidad principal es la de obtener el nombre del pictograma que se desea buscar y enviarlo al servicio de aplicación, añadir los pictogramas al traductor y por ultimo mostrar los errores gracias al servicio de modales.
 
El servicio de aplicación creara la URL para hacer la llamada al Servicio Web de búsqueda del pictogramas asociados a una palabra, visto en el capitulo \ref{cap5:sec:ServiciosParaPictosPalabra}, usando el archivo de constantes. Con la URL generada llamara al Servicio Proxy, que se encargara de enviar y recibir la respuesta del servicio web. Si la respuesta es correcta el servicio de aplicación hará uso del transformer para generar un objecto para el controlador, en caso de error devolverá el error al controlador para que muestre el mensaje de error.
Podemos ver un diagrama de clase del componente buscador en la Figura \ref{fig:finderClass}.    
\figura{Bitmap/Arquitectura/finderClass}{width=300px}{fig:finderClass}{Diagrama de clase del componente buscador de pictogramas}


%------------------------------------------------------------------
\section{Back-End}
%-------------------------------------------------------------------


%------------------------------------------------------------------
\subsection{Servicio Web de Clasificación de Palabras}
%-------------------------------------------------------------------
\label{cap5:sec:ServicioClasificaciónDePalabras}

El servicio web de clasificación de palabras, se encarga de dada una palabra o un array de palabras devolver la categoría léxica (verbo, nombre, adverbio, determinante, adjetivo...) y todos los atributos ( genero, numero, tiempo verbal...) de cada una de las palabras recibidas.
Una vez se tiene la entrada se llama a la  función Tokenizer\footnote{https://spacy.io/api/tokenizer} de la librería Spacy, cabe destacar que esta llamada se hará por cada una de las palabras que se reciba. Para obtener la categorización léxica de la palabra y los atributos de la mismas, los diferentes resultados de este servicio web están reflejados en las tablas \ref{tabla:clasificacion}.

\begin{table}[htbp]
\begin{center}
\begin{tabular}{|l|l|l|l|}
\hline
Categoría Léxica & Atributos \\
\hline \hline
Verbo & Forma verbal  \\ \hline
Nombre & Genero, número  \\ \hline
Determinante & Género, numero, tipo de determinante, determinante definido o indefinido \\ \hline
Adjetivo & Género, numero\\ \hline
Pronombre & Género, numero, persona, tipo de pronombre\\ \hline
Adverbio & -\\ \hline
Preposiciones & Tipo de preposiciones\\ \hline
Conjunciones & -\\ \hline
\end{tabular}
\caption{Tabla de características devueltas por el servicio según la categoría léxica.}
\label{tabla:clasificacion}
\end{center}
\end{table}
\figura{Bitmap/ServiciosWeb/attrsResponsePost}{height=18cm, width=7cm}{fig:attrsResponsePost}{Respuesta del servicio web de clasificación de palabras para la entrada [corredor, despistado, perder, zapatillas, ayer].}
\figura{Bitmap/ServiciosWeb/caracPal}{height=10cm}{fig:caracPal}{Flujo del servicio web de clasificación de palabras} 

La salida de la función tokenizer sera procesada para generar el JSON que sera la salida de nuestro sistema. En la Figura \ref{fig:attrsResponsePost}, podemos ver la respuesta del servicio web para la entrada [corredor, despistado, perder, zapatillas, ayer].
En la Figura \ref{fig:caracPal}, podemos ver un resumen del flujo que sigue este servicio.


%------------------------------------------------------------------
\subsection{Servicio Web de Detección de Tiempo Verbal}
%-------------------------------------------------------------------
\label{cap5:sec:ServiciodeDeteccióndeTiempoVerbal}

Este servicio web, tiene como finalidad determinar el tiempo verbal de una frase dado la lista de palabras que conforman la frase. Este servicio busca las palabras temporales, ayer, hoy o mañana en el array de palabras recibido como entrada. Si encuentra alguna de estas palabras devuelve el tiempo verbal correspondiente, pasado si encontró ayer, presente si encontró hoy y futuro si encontró mañana. En caso de no encontrar ninguna de las 3 palabras devuelve presente por defecto. 
\figura{Bitmap/ServiciosWeb/deteccionTiempoVerbal}{width=100px}{fig:deteccionTiempoVerbal}{Flujo del servicio web de detección del tiempo verbal} 
\figura{Bitmap/ServiciosWeb/timeDeteccion}{width=100px}{fig:timeDeteccion}{respuesta del servicio web de detección del tiempo verbal para la entrada [corredor, despistado, perder, zapatillas, ayer]} 
En la Figura \ref{fig:deteccionTiempoVerbal}, podemos ver un resumen del flujo que sigue este servicio y en las Figura \ref{fig:timeDeteccion} podemos ver un ejemplo de salida para la entrada [corredor, despistado, perder, zapatillas, ayer].

%------------------------------------------------------------------
\subsection{Servicio Web de Generación de Frases en Lenguaje Natural}
%-------------------------------------------------------------------
\label{cap5:sec:ServicioGLN}

Este servicio web recibe un array de strings y devuelve una frase creada a partir de las palabras recibidas en la llamada. Los pasos seguidos por el servicio para crear la frase de salida son los siguiente:

\begin{enumerate}

\item Obtención de la categoría léxica de cada una de las palabras: Se llama al Servicio Web de Clasificación de Palabras explicado en la sección \ref{cap5:sec:ServicioClasificaciónDePalabras}, utilizando el metodo POST que permite enviar todo el array de palabras, para obtener las características y la categoría léxica de cada palabra.

\item División de palabras en sintagma nominal y en sintagma verbal: una vez conocemos la categoría léxica de las palabras, buscamos el verbo dentro del array de palabras. Todas las palabras anteriores al verbo formaran el sintagma nominal y todas las posteriores el sintagma verbal.

\item Una vez identificadas las palabras que forman parte del sujeto se pasa a procesar el sujeto de la frase.

\begin{itemize}
\item Selección del determinante: En este proceso se selecciona un determinante en caso de que sea necesario, es decir si es un nombre común (por ejemplo  ``corredor, perro, bailarina''), por defecto el determinante es \textit{el o la}. Si la palabra principal es un determinante como ``el, ella, nosotros", no se añade.
\item Genero y número: se selecciona el genero y numero de la palabra principal del sujeto, y se configura en todo el sujeto, de manera que si el nombre es femenino plural como por ejemplo ``mujeres, contento'' el sujeto resultante sera ``Las mujeres contentas''.
\item En caso de encontrar un adverbio dentro del array de palabras se fuerza su posición dentro del sujeto al final del sujeto, y así la entrada ``profesora ayer,comer,galletas,duro'' generara la frase ``La profesora ayer comió galletas duras''
\end{itemize}

\item De la misma manera que con el sujeto, se obtienen las palabras que formaran el predicado excluyendo el verbo. En caso de tener palabras de categoría léxica ``nombre'' se configura la parte objeto del predicado utilizando el genero y numero obtenido. De manera que si el array está formado por las palabras ``galletas, duro'' el resultado sera `` galletas duras''.
Si existe un adverbio se fuerza su posición al final de la frase, de manera que si las palabras que conformaran la frase final contienen ``profesora, comer, ayer, galletas, duro'', la frase resultante sera ``La profesora comío galletas duras ayer''. 

\item A continuación se hace una llamada al Servicio Web de Detección de Tiempo Verbal, para obtener el tiempo verbal el que se debe conjugar la frase resultante.


\item El tiempo verbal de la frase se escoge, dependiendo de la respuesta del Servicio de Detección de Tiempo Verbal. Diferenciamos tres tipos de respuesta,
pasado, futuro y presente que es la configuración de tiempo verbal por defecto.

\item Una vez tenemos todos las partes de la frase se pasa a la realización de la misma. Se detecta si existen predicados y el objeto de la frase, y en caso de que existan se añaden a la frase, se forma la frase final gracias a SimpleNLG, está fase se denomina realización, el resultado de está fase sera devuelto en la respuesta del servicio web.

\end{enumerate}
En la Figura \ref{fig:NLGService}, podemos ver un resumen del flujo que sigue este servicio.
\figura{Bitmap/ServiciosWeb/NLGService}{width=350px}{fig:NLGService}{Flujo del Servicio Web de Detección de Generación de Frases en Lenguaje Natural} 

En la tabla \ref{tabla:tiempoVerbal} podemos ver un resumen con diferentes entradas de este Servicio Web.
\begin{table}[htbp]
\begin{tabular}{p{1.5cm}p{1cm}p{1.2cm}p{1cm}p{2cm}p{1cm}p{1cm}p{3cm}}
\hline
Sujeto & Adj. & Adv. & Verbo & Objecto & Adj. & Adv. & Resultado \\
\hline \hline
Corredor & -&-&Perder & Zapatillas &- &- & El corredor pierde unas zapatillas\\ \hline
Corredor & Rápido &- & Perder & Zapatillas&- &- & El corredor rápido pierde unas zapatillas\\ \hline
Corredor & - & Ayer & Perder & Zapatillas &- &-& El corredor ayer perdió unas zapatillas.\\ \hline
Corredor & - & Mañana & Perder & Zapatillas &- &-& El corredor mañana perderá unas zapatillas.\\ \hline
Corredor & Rápido & Ayer & Perder & Zapatillas &- &- & El corredor rápido ayer perdió unas zapatillas.\\ \hline
Corredor & -&-&Perder & Zapatillas &Nuevo &- & El corredor pierde unas zapatillas nuevas\\ \hline
Corredor &Rápido &-&Perder & Zapatillas &Nuevo &- & El corredor rápido pierde unas zapatillas nuevas\\ \hline
Corredor &Rápido &Ayer &Perder & Zapatillas &Nuevo &- & El corredor rápido ayer perdió unas zapatillas nuevas.
\\ \hline
Corredor &Rápido &- &Perder & Zapatillas &Nuevo &Ayer & El corredor rápido perdió unas zapatillas nuevas ayer.
\\ \hline
\end{tabular} 
\caption{Tabla con diferentes entradas y salidas del Servicio Web de Generación de Frases en Lenguaje Natural.}
\label{tabla:tiempoVerbal}
\end{table}

%------------------------------------------------------------------
\subsection{Servicios Web para la gestión de pictogramas} %-------------------------------------------------------------------
\label{cap5:sec:ServiciosParaPictos}

En esta subsección pasaremos a explicar los dos servicios web, que hemos creado para tratar con pictogramas. Para creación de estos servicios hemos utilizando la API de ARASAAC\footnote{https://beta.arasaac.org/developers/api}. Ambos servicios  siguen la misma linea de ejecución, la cual se muestra en la Figura \ref{fig:serviciosAPIARAASAC}. 
\figura{Bitmap/ServiciosWeb/serviciosAPIARAASAC}{width=200px}{fig:serviciosAPIARAASAC}{Flujo de los Servicios Web Para Pictogramas } 

\subsection{Servicio Web de búsqueda del pictogramas asociados a una palabra}
\label{cap5:sec:ServiciosParaPictosPalabra}
Este servicio web, recibe una palabra a través de una petición GET y devuelve un objeto en formato JSON, con un array de objetos con los diferentes pictogramas asociados a la palabra recibida.
Este servicio lanza una petición GET al buscador de pictogramas de la API de ARAASAC\footnote{https://api.arasaac.org/api/pictograms/api/pictograms/es/search/'Nombre'}, el cual devuelve una lista de pictogramas, con todos los pictogramas en los que aparece la palabra introducida.
La respuesta devuelta por la API de ARAASAC es procesada, eliminando los resultados que no son deseados, por ejemplo si se realiza la busqueda huevo, la API de ARAASAC devolverá tres pictogramas: huevo, huevo frito, huevo roto, por lo que los dos últimos se excluirán. Por cada pictograma se genera un objecto con los siguientes atributos:
\begin{itemize}
\item Identificador del pictograma.
\item URL externa a la imagen del pictograma.
\item El significado del pictograma.
\end{itemize}
Cada objecto se añade a una lista que sera devuelta en el resultado de este servicio web tal y como podemos ver en la Figurac \ref{fig:pictoFinderResponse}, para la entrada ``huevo''.
\figura{Bitmap/ServiciosWeb/pictoFinderResponse}{width=400px}{fig:pictoFinderResponse}{Respuesta del buscador por id de la API de ARAASAC} 

\subsection{Servicio web de traducción}

Este servicio web recibe un identificador de un pictograma y devuelve las diferentes palabras asociadas al pictograma.
\begin{itemize}
\item Una vez el servicio recibe un identificador, lanza una petición al buscador de pictogramas de la API de ARASAAC\footnote{https://api.arasaac.org/api/pictograms/es/`idPictograma'}. En la Figura \ref{fig:finderIDAPI} podemos ver la respuesta para el Identificador 7823.
\figura{Bitmap/ServiciosWeb/finderIDAPI}{width=300px}{fig:finderIDAPI}{Respuesta del buscador por id de la API de ARAASAC} 
\item Se accede al atributo ``Keywords'' del objeto devuelto por la API, se encapsula dentro de un objeto, y se devuelve dentro de un JSON tal y como se puede ver en la Figura \ref{fig:responseTranslatePictoService}.
\figura{Bitmap/ServiciosWeb/responseTranslatePictoService}{width=300px}{fig:responseTranslatePictoService}{Respuesta del buscador por id de la API de ARAASAC} 
\end{itemize}