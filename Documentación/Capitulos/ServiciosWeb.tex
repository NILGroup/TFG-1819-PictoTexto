% !TeX encoding = ISO-8859-1

\chapter{Servicios Web para la Traducción de Pictogramas a Texto}
\label{cap:serviciosWeb}
\figura{Bitmap/ServiciosWeb/ServiciosWebDiagrama}{width=400px}{fig:ServiciosWebDiagrama}{Diagrama de los diferentes Servicios Web} 
A lo largo de este capitulo se presentaran los diferentes servicios web, que hemos implementado, para la traducción de mensajes con pictogramas y veremos como se integran entre ellos, en la Figura \ref{fig:ServiciosWebDiagrama}, podemos ver un diagrama de los diferentes servicios web, su relación entre ellos y la vista de la aplicación.


%------------------------------------------------------------------
\section{Servicio Web de Clasificación De Palabras}
%-------------------------------------------------------------------
\label{cap5:sec:ServicioClasificaciónDePalabras}

El Servicio Clasificación De Palabras, se encarga de dada una palabra o un array de palabras devolver la categoría léxica y todos los atributos de cada una de las palabras recibidas.
Una vez se tiene la entrada se llama a la libreria Spacy que ya ha sido cargada previamente, y se utiliza su función Tokenizer\footnote{https://spacy.io/api/tokenizer}. Esta función sirve para obtener las características y la categorización léxica de una palabra. 
Las características y diferentes categorías léxicas de las palabras, que seran devueltas por este servicio web están reflejadas en las tablas \ref{tabla:cat1} y \ref{tabla:cat2}.
\begin{table}[htbp]
\begin{center}
\begin{tabular}{|l|l|l|l|}
\hline
Verbo & Nombre & Adjetivo & Determinante \\
\hline \hline
Cat. Léxica & Cat. Léxica & Cat. Léxica & Cat. Léxica \\ \hline
Forma verbal & Número & Número & Número \\ \hline
 - & Género  & Género  & Tipo \\ \hline
\end{tabular}
\caption{Tabla de características de Verbos, Nombres, Adjetivos y Determinantes .}
\label{tabla:cat1}
\end{center}
\end{table}

\begin{table}[htbp]
\begin{center}
\begin{tabular}{|l|l|l|}
\hline
 Adverbio & Pronombre & Preposiciones  \\
\hline \hline
Cat. Léxica &Cat. Léxica &Cat. Léxica \\ \hline
- &- &Tipo \\ \hline
\end{tabular}
\caption{Tabla de características de Adverbios, Pronombres, Preposiciones.}
\label{tabla:cat2}
\end{center}
\end{table}

\figura{Bitmap/ServiciosWeb/attrsResponsePost}{width=300px}{fig:attrsResponsePost}{Respuesta del Servicio Clasificación De Palabras } 
Dado que la salida de la función Tokenizer devuelve un string, se parsea su salida y se genera un objeto en formato JSON que sera la salida del servicio web. En la Figura \ref{fig:attrsResponsePost}, podemos ver la respuesta del servicio web para la entrada perro, rápido, comer, pan.
En la Figura \ref{fig:caracPal}, podemos ver un resumen del flujo que sigue este servicio.
\figura{Bitmap/ServiciosWeb/caracPal}{width=100px}{fig:caracPal}{Flujo del Servicio Clasificación De Palabras} 

%------------------------------------------------------------------
\section{Servicio de Detección de Tiempo Verbal}
%-------------------------------------------------------------------
\label{cap5:sec:ServiciodeDeteccióndeTiempoVerbal}

Este servicio web, tiene como finalidad determinar el tiempo verbal de una frase dado una lista de palabras. Después de recibir la petición busca alguna de las  palabras clave, que esta en la tabla \ref{tabla:tiempoVerbal}, en la lista de palabras recibida. Si detecta alguna de las palabras clave devuelve en un JSON con el tiempo verbal correspondiente a dicha palabra clave. En caso de no encontrar ninguna de las palabras clave, el servicio web devolverá presente.


\begin{table}[htbp]
\begin{center}
\begin{tabular}{|l|l|l|}
\hline
Presente & Pasado & Futuro \\
\hline \hline
Hoy & Ayer & Mañana \\ \hline
\end{tabular}
\caption{Tabla de palabras clave para la detección del tiempo verbal.}
\label{tabla:tiempoVerbal}
\end{center}
\end{table}

En la Figura \ref{fig:deteccionTiempoVerbal}, podemos ver un resumen del flujo que sigue este servicio.
\figura{Bitmap/ServiciosWeb/deteccionTiempoVerbal}{width=200px}{fig:deteccionTiempoVerbal}{Flujo del Servicio Web de Detección del Tiempo Verbal} 

%------------------------------------------------------------------
\section{Servicio de Generación de Lenguaje Natural}
%-------------------------------------------------------------------
\label{cap5:sec:ServicioGLN}

Como ya hemos hablado anteriormente, hemos utilizado la librería SimpleNLG-ES\footnote{https://github.com/citiususc/SimpleNLG-ES}.
El servicio de generación de lenguaje natural \footnote{/NLGWebService/createPhrase}
) recibe un JSON con un array de strings, tal y como podemos ver en la Figura \ref{fig:nlgResponse}, y su finalidad es devolver una frase con las palabras recibidas en la llamada. En la Figura \ref{fig:nlgRequest} podemos ver la respuesta de este servicio a la llamada de las palabras ``perro, rápido, comer, pan, duro".

\figura{Bitmap/ServiciosWeb/responseTranslateService}{width=300px}{fig:nlgResponse}{Petición al servicio de creación del lenguaje}
\figura{Bitmap/ServiciosWeb/translateService}{width=300px}{fig:nlgRequest}{Respuesta del servicio de creación del lenguaje}


Una vez el servidor recibe la petición Post, la librería GSON se encarga de parsear la entrada para convertir el JSON de entrada en un ArrayList de Strings. Este paso es necesario dado que Java reconoce los JSON como una cadena de texto, y utilizando esta librería podemos conseguir una clase implementada usando un JSON y el tipo de clase Java representado por el JSON.

Cuando la entrada es transformada de manera correcta, se llama al Servicio Web de Clasificación de Palabras, a través de una petición POST, y usando también una petición POST con los mismos datos se llama al Servicio Web de Detección de Tiempo Verbal, y de esa manera obtenemos el tiempo verbal en el que se debe conjugar la frase.

Gracias al resultado de esta clasificación podemos determinar la posición del verbo, con lo cual podemos dividir la lista de palabras en aquellas que formaran el sujeto (aquellas que están antes del verbo) y aquellas que formaran el objecto (palabras encontradas después del verbo).

Una vez identificadas las palabras que forman parte del sujeto se pasa a procesar el sujeto de la frase. En este proceso se configura un determinante en caso de que sea necesario, es decir si es un nombre común por ejemplo ``corredor, perro, bailarina", por defecto el determinante es \textit{ el o la},por ejemplo ``corredora,rapido'' generara ``La corredora rapida''.En palabra principal sea un determinante como ``el, ella, nosotros", no se añade ningún determinante. Además, se obtiene el genero y numero del nombre principal del sujeto, para proceder a la configuración de los mismos de todo el sujeto, de manera que si el nombre es femenino plural como por ejemplo ``mujeres, contento'' el sujeto resultante sera ''Las mujeres contentas''.

De la misma manera que con el sujeto, se recorre el array de palabras objeto, y si se encuentran palabras de categoría léxica ``nombre'' se configura la parte objeto del predicado utilizando el genero y numero obtenido. De manera que si el array está formado por las palabras ``galletas, duro'' el resultado sera `` galletas duras''.

El tiempo verbal de la frase se escoge, dependiendo de la respuesta del Servicio de Detección de Tiempo Verbal. Diferenciamos tres tipos de respuesta,
pasado, futuro y presente que es la configuración de tiempo verbal por defecto.

En caso de encontrar un adverbio se fuerza su posición al final de la frase que formara el objeto, si se encuentra dentro del array de palabras objecto,  de manera que si las palabras que conformaran la frase final contienen ``profesora,comer,ayer,galletas,duro'', la frase resultante sera ``La profesora comío galletas duras ayer''. En caso de encontrar el adverbio dentro del array de palabras del sujeto se pondrá al final del sujeto, y así la entrada ``profesora ayer,comer,galletas,duro'' generara la frase ``La profesora ayer comío galletas duras''


Una vez tenemos todos las partes de la frase se pasa a la realización de la misma. Se detecta si existen predicados y el objeto de la frase, y en caso de que existan se añaden a la frase, se forma la frase final gracias a SimpleNLG, está fase se denomina realización, el resultado de está fase sera devuelto en la respuesta del servicio tal y como podemos ver en la Figura \ref{fig:nlgRequest}, para la entrada ``perro, rápido, comer, pan, duro''.
A continuación repasaremos otros ejemplos de entradas:
\begin{itemize}
\item Entrada simple sujeto, verbo, objeto (Profesor,comer,galletas
\item Entrada con adjetivo en el sujeto, adjetivo, verbo, objeto: ''Profesor, listo, comer, galletas'' -> ``El profesor listo come galletas''
\item Entrada con adverbio en el sujeto, adverbio, verbo, objeto: ''Profesor, ayer, comer, galletas'' -> ''El profesor ayer comió galletas''
\item Entrada con adjetivo y adverbio temporal en el sujeto: sujeto, adjetivo, adverbio, verbo, objeto: ''Profesor, listo, ayer, comer, galletas'' -> ''El profesor listo ayer comió galletas''
\item Entrada con adjetivo en el predicado: sujeto, verbo, objeto, adjetivo: ''Profesor, comer, galletas, duro'' -> ''El profesor come galletas duras''
\item Entrada con adverbio en el predicado: sujeto, verbo, adverbio temporal, objeto: ''Profesor, comer, galletas, ayer'' -> ''El profesor comió galletas ayer''
\item Entrada con adjetivo y adverbio en el predicado, adverbio, adjetivo, verbo, objeto: ''Profesor, comer, galletas, duro, ayer'' -> ''El profesor commió galletas duras ayer''
\end{itemize}

%------------------------------------------------------------------
\section{Servicios para la gestión de pictogramas} %-------------------------------------------------------------------
\label{cap5:sec:ServiciosParaPictos}

Para la obtención de los pictogramas, así como su significado se han implementado una serie de servicios web que hacen uso de la API de ARASAAC\footnote{https://beta.arasaac.org/developers/api}. 
En esta subsección pasaremos a desarrollar los diferentes servicios web, que utilizamos para llamar a la API de ARASAAC, y crear las respuestas necesarias:

\subsection{Servicio web de búsqueda}

Este servicio web\footnote{/picto/getPicto?pictoName=`NombrePictograma'}, recibe una palabra a través de una petición GET tal y como podemos ver en la Figura \ref{fig:pictoFinderRequest}, y devuelve un objeto en formato JSON.
\figura{Bitmap/ServiciosWeb/pictoFinderRequest}{width=400px}{fig:pictoFinderRequest}{Petición al servicio de búsqueda de pictogramas}
Este servicio lanza una petición GET a un servicio web externo\footnote{https://api.arasaac.org/api/pictograms/api/pictograms/es/search/'Nombre'} de la API de ARAASAC, el cual devuelve una lista de pictogramas. La respuesta devuelta por la API de ARAASAC es procesada para quedarnos con los siguientes datos de cada pictograma: identificador del pictograma, la URL al archivo con la imagen asociado al pictograma de ARASAAC y el significado. A continuación se crea una lista con todos los pictogramas y sus datos y se genera un JSON que sera la salida del servicio.

\figura{Bitmap/ServiciosWeb/pictoFinderResponse}{width=300px}{fig:pictoFinderResponse}{Respuesta del servicio de búsqueda de pictogramas para la palabra casa}

\subsection{Servicio web de traducción}

Este segundo servicio web tiene diferentes end-points, accesibles desde /translate:

Servicio de traducción de pictogramas\footnote{/translate/getPictoTranslate?pictoId='XXXX'} recibe el identificador de un pictograma tal y como podemos ver en la Figura \ref{fig:translateResponse} y obtiene todos los significados de dicho pictograma haciendo uso de una llamada a la API de ARASAAC de busqueda de pictogramas por id\footnote{https://api.arasaac.org/api/pictograms/es/`idPictograma'}. Encapsula dentro de un objeto los valores necesarios obtenidos de la respuesta del servicio de ARAASAC, y lo devuelve dentro de un JSON, tal y como podemos ver en la Figura  \ref{fig:responsetranslateService}.
\figura{Bitmap/ServiciosWeb/translateService}{width=300px}{fig:translateResponse}{Llamada al servicio web de traducción de pictogramas, para el pictograma 2317}
\figura{Bitmap/ServiciosWeb/responsetranslateService}{width=300px}{fig:responsetranslateService}{Respuesta del servicio de traducciones de pictogramas}

